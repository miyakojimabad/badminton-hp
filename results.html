<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>大会結果｜宮古バドミントン協会</title>
  <meta name="description" content="宮古バドミントン協会の大会結果ページ。結果PDF、入賞者、トーナメント表などを掲載します。" />
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <header class="header">
    <div class="container">
      <nav class="nav">
        <a class="brand" href="index.html">
          <div class="brand-mark" aria-hidden="true"></div>
          <div class="brand-title">
            <strong>宮古バドミントン協会</strong>
            <span>公式サイト</span>
          </div>
        </a>

        <div class="menu">
          <a href="index.html">トップ</a>
          <a href="tournaments.html">大会情報</a>
          <a class="active" href="results.html">結果</a>
          <a href="about.html">協会について</a>
          <a href="contact.html">問い合わせ</a>
        </div>
      </nav>
    </div>
  </header>

  <main>
    <section class="section">
      <div class="container">
        <h1>大会結果</h1>
        <p class="small" style="margin-top:8px;">
          結果PDF、入賞者、トーナメント表などを掲載できます（スプレッドシートから自動反映）。
        </p>

        <div class="grid" id="resultsGrid" style="margin-top:18px;">
          <div class="card box">読み込み中...</div>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="container">
      <div class="row">
        <div>© <span id="y"></span> 宮古バドミントン協会</div>
        <div>更新担当：竹中悠（連絡先は問い合わせページへ）</div>
      </div>
    </div>
  </footer>

  <script>
    document.getElementById("y").textContent = new Date().getFullYear();
  </script>

  <!-- ===== スプレッドシート連携（JSONP版） ===== -->
  <script>
    // ★あなたのApps Script WebアプリURL（/execまで）に置き換え
    const API_BASE = "https://script.googleusercontent.com/macros/s/AKfycbzSk_APUGIBsY1GXxy7OHhlMmsbgguy2xrOTi3qrExbFsap8wOM6s_b-vQnyvPvGXW0/exec";

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    // 2026-01-10T15:00:00.000Z → 2026-01-10
    function formatDate(d){
      if(!d) return "";
      const dt = new Date(d);
      if (isNaN(dt)) return String(d);     // もし既に文字列ならそのまま
      return dt.toISOString().slice(0,10); // YYYY-MM-DD
    }

    // JSONP（CORS回避）
    function jsonp(type){
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Math.random().toString(16).slice(2);
        window[cb] = (data) => {
          delete window[cb];
          script.remove();
          resolve(data);
        };
        const script = document.createElement("script");
        script.src = `${API_BASE}?type=${encodeURIComponent(type)}&callback=${cb}`;
        script.onerror = () => reject(new Error("JSONP load failed"));
        document.body.appendChild(script);
      });
    }

    async function fetchItems(type){
      const data = await jsonp(type);
      if(!data.ok) throw new Error(data.error || "API error");
      return data.items || [];
    }

    // ===== 結果 =====
    async function loadResults(){
      const el = document.getElementById("resultsGrid");
      if(!el) return;

      try{
        const items = await fetchItems("results");

        // active列があるなら TRUE のみ表示（なければ全表示）
        const list = items.filter(r => {
          const a = r.active;
          if (a === undefined || a === null || a === "") return true;
          return String(a).toLowerCase() === "true";
        });

        if(list.length === 0){
          el.innerHTML = `<div class="card box">結果はまだありません</div>`;
          return;
        }

        el.innerHTML = list.map(r => {
          const title = esc(r.name || "");
          const date  = esc(formatDate(r.date));
          // note列（見出しが note ならこれでOK）
          // もし見出しが「備考」などなら r["備考"] に変更してね
          const note  = esc(r.note || "");
          const pdf   = r.result_pdf ? esc(r.result_pdf) : "";

          return `
            <div class="card box">
              <div class="meta">
                <span>${date}</span>
              </div>

              <h3>${title}</h3>

              ${note ? `<p class="small" style="margin-top:8px;">${note}</p>` : ""}

              <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
                ${pdf
                  ? `<a class="btn" href="${pdf}" target="_blank" rel="noopener">結果PDFを見る →</a>`
                  : `<span class="small">PDF未設定</span>`
                }
              </div>
            </div>
          `;
        }).join("");

      }catch(e){
        console.error(e);
        el.innerHTML = `<div class="card box">結果の読み込みに失敗しました</div>`;
      }
    }

    loadResults();
  </script>
</body>
</html>
